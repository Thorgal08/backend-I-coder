<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-primary">Mi Carrito</h1>
    <a href="/products" class="btn btn-outline-primary">
      <i class="bi bi-arrow-left"></i> Seguir comprando
    </a>
  </div>

  {{#if cart.products.length}}
    <div class="row">
      <div class="col-md-8">
        {{#each cart.products}}
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-0">
              <div class="col-md-2">
                {{#if this.product.thumbnails}}
                  <img src="{{this.product.thumbnails}}" class="img-fluid rounded" alt="{{this.product.title}}">
                {{else}}
                  <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 80px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                {{/if}}
              </div>
              <div class="col-md-6">
                <h5 class="card-title">{{this.product.title}}</h5>
                <p class="card-text text-muted">{{this.product.description}}</p>
                <small class="text-muted">Código: {{this.product.code}}</small>
              </div>
              <div class="col-md-2 text-center">
                <h6 class="text-muted">Precio</h6>
                <span class="h5 text-primary">${{this.product.price}}</span>
              </div>
              <div class="col-md-2 text-center">
                <h6 class="text-muted">Cantidad</h6>
                <div class="input-group input-group-sm">
                  <button class="btn btn-outline-secondary" onclick="updateQuantity('{{../cartId}}', '{{this.product._id}}', {{this.quantity}}, -1)">-</button>
                  <input type="text" class="form-control text-center" value="{{this.quantity}}" readonly>
                  <button class="btn btn-outline-secondary" onclick="updateQuantity('{{../cartId}}', '{{this.product._id}}', {{this.quantity}}, 1)">+</button>
                </div>
                <div class="mt-2">
                  <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart('{{../cartId}}', '{{this.product._id}}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        {{/each}}
      </div>

      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Resumen del pedido</h5>
            
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span id="subtotal">${{calculateSubtotal cart.products}}</span>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span>Envío:</span>
              <span>Gratis</span>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between mb-3">
              <strong>Total:</strong>
              <strong id="total">${{calculateSubtotal cart.products}}</strong>
            </div>

            <div class="d-grid gap-2">
              <form action="/cart/checkout" method="POST" onsubmit="return confirmPurchase()">
                <button type="submit" class="btn btn-success btn-lg w-100">
                  <i class="bi bi-credit-card"></i> Finalizar Compra
                </button>
              </form>
              <button class="btn btn-outline-danger" onclick="clearCart('{{cartId}}')">
                <i class="bi bi-trash"></i> Vaciar carrito
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  {{else}}
    <div class="text-center py-5">
      <i class="bi bi-cart-x text-muted" style="font-size: 4rem;"></i>
      <h3 class="mt-3 text-muted">Tu carrito está vacío</h3>
      <p class="text-muted">Agrega algunos productos para comenzar</p>
      <a href="/products" class="btn btn-primary btn-lg">
        <i class="bi bi-shop"></i> Explorar productos
      </a>
    </div>
  {{/if}}
</div>

<script>
async function updateQuantity(cartId, productId, currentQuantity, change) {
  const newQuantity = currentQuantity + change;
  
  if (newQuantity <= 0) {
    removeFromCart(cartId, productId);
    return;
  }

  try {
    const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ quantity: newQuantity })
    });

    if (response.ok) {
      location.reload();
    } else {
      alert('Error actualizando cantidad');
    }
  } catch (error) {
    alert('Error actualizando cantidad');
  }
}

async function removeFromCart(cartId, productId) {
  if (!confirm('¿Estás seguro de eliminar este producto del carrito?')) return;

  try {
    const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      location.reload();
    } else {
      alert('Error eliminando producto');
    }
  } catch (error) {
    alert('Error eliminando producto');
  }
}

async function clearCart(cartId) {
  if (!confirm('¿Estás seguro de vaciar todo el carrito?')) return;

  try {
    const response = await fetch(`/api/carts/${cartId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      location.reload();
    } else {
      alert('Error vaciando carrito');
    }
  } catch (error) {
    alert('Error vaciando carrito');
  }
}

function confirmPurchase() {
  const total = document.getElementById('total').textContent;
  return confirm(`¿Confirmas la compra por ${total}?\n\nSe procesará el pago y se vaciará tu carrito.`);
}
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
