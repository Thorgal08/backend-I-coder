<div class="container-fluid py-4">
  <!-- Header del e-commerce -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="bg-gradient-primary rounded p-4 text-white mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h2 mb-1">üõí Tienda Online</h1>
            <p class="mb-0 opacity-75">Descubre los mejores productos al mejor precio</p>
          </div>
          <div class="d-flex gap-2">
            <button onclick="goToCurrentCart()" class="btn btn-light btn-lg">
              <i class="bi bi-bag"></i> Mi Carrito <span id="cart-counter" class="badge bg-danger ms-1" style="display: none;"></span>
            </button>
            <a href="/" class="btn btn-outline-light">
              <i class="bi bi-house"></i> Inicio
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros avanzados -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="bi bi-funnel"></i> Filtros y B√∫squeda
          </h5>
        </div>
        <div class="card-body">
          <form method="GET" class="row g-3">
            <div class="col-md-3">
              <label class="form-label fw-bold">
                <i class="bi bi-search"></i> Categor√≠a
              </label>
              <select name="category" class="form-select">
                <option value="">Todas las categor√≠as</option>
                {{#each categories}}
                  <option value="{{this}}" {{#if (eq this ../query.category)}}selected{{/if}}>{{this}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">
                <i class="bi bi-toggle-on"></i> Estado
              </label>
              <select name="status" class="form-select">
                <option value="">üîç Todos</option>
                <option value="true" {{#if (eq query.status 'true')}}selected{{/if}}>‚úÖ Disponibles</option>
                <option value="false" {{#if (eq query.status 'false')}}selected{{/if}}>‚ùå No disponibles</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">
                <i class="bi bi-sort-numeric-down"></i> Precio
              </label>
              <select name="sort" class="form-select">
                <option value="">üîÄ Sin orden</option>
                <option value="asc" {{#if (eq query.sort 'asc')}}selected{{/if}}>üí∞ Menor a mayor</option>
                <option value="desc" {{#if (eq query.sort 'desc')}}selected{{/if}}>üíé Mayor a menor</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label fw-bold">
                <i class="bi bi-list-ol"></i> Mostrar
              </label>
              <select name="limit" class="form-select">
                <option value="5" {{#if (eq query.limit '5')}}selected{{/if}}>5 productos</option>
                <option value="10" {{#if (eq query.limit '10')}}selected{{/if}}>10 productos</option>
                <option value="20" {{#if (eq query.limit '20')}}selected{{/if}}>20 productos</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-primary flex-fill">
                <i class="bi bi-search"></i> Buscar
              </button>
              <a href="/products" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i> Reset
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de productos profesional -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-grid"></i> Cat√°logo de Productos
            </h5>
            <span class="badge bg-primary fs-6">{{products.length}} productos encontrados</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            {{#each products}}
            <div class="list-group-item border-0 product-item" data-product-id="{{this._id}}">
              <div class="row align-items-center py-3">
                <!-- Imagen del producto -->
                <div class="col-md-2 col-3">
                  <div class="product-image-wrapper position-relative">
                    {{#if this.thumbnails}}
                      <img src="{{this.thumbnails}}" 
                           class="img-fluid rounded shadow-sm border" 
                           style="width: 90px; height: 90px; object-fit: cover;"
                           alt="{{this.title}}">
                    {{else}}
                      <div class="bg-gradient rounded d-flex align-items-center justify-content-center shadow-sm border" 
                           style="width: 90px; height: 90px; background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
                        <i class="bi bi-image text-primary fs-3"></i>
                      </div>
                    {{/if}}
                    <!-- Badge de disponibilidad -->
                    {{#if this.status}}
                      <span class="position-absolute top-0 end-0 badge bg-success rounded-pill">
                        <i class="bi bi-check"></i>
                      </span>
                    {{else}}
                      <span class="position-absolute top-0 end-0 badge bg-danger rounded-pill">
                        <i class="bi bi-x"></i>
                      </span>
                    {{/if}}
                  </div>
                </div>
                
                <!-- Informaci√≥n del producto -->
                <div class="col-md-4 col-9">
                  <div class="product-info">
                    <h5 class="product-title mb-1 fw-bold text-dark">{{this.title}}</h5>
                    <p class="product-description text-muted mb-2 small">{{this.description}}</p>
                    <div class="product-meta d-flex flex-wrap gap-1">
                      <span class="badge bg-light text-dark border">
                        <i class="bi bi-upc-scan"></i> {{this.code}}
                      </span>
                      <span class="badge bg-info text-white">
                        <i class="bi bi-tag"></i> {{this.category}}
                      </span>
                      {{#if (gt this.stock 0)}}
                        <span class="badge bg-success">
                          <i class="bi bi-check-circle"></i> En stock
                        </span>
                      {{else}}
                        <span class="badge bg-danger">
                          <i class="bi bi-x-circle"></i> Agotado
                        </span>
                      {{/if}}
                    </div>
                  </div>
                </div>
                
                <!-- Precio prominente -->
                <div class="col-md-2 text-center">
                  <div class="price-section">
                    <div class="current-price">
                      <span class="fs-3 fw-bold text-success">${{this.price}}</span>
                    </div>
                    <div class="stock-indicator mt-1">
                      {{#if (gt this.stock 20)}}
                        <span class="badge bg-success px-3 py-1">
                          <i class="bi bi-check-circle"></i> Stock: {{this.stock}}
                        </span>
                      {{else if (gt this.stock 5)}}
                        <span class="badge bg-warning text-dark px-3 py-1">
                          <i class="bi bi-exclamation-triangle"></i> Quedan: {{this.stock}}
                        </span>
                      {{else if (gt this.stock 0)}}
                        <span class="badge bg-danger px-3 py-1">
                          <i class="bi bi-exclamation-circle"></i> ¬°√öltimas {{this.stock}}!
                        </span>
                      {{else}}
                        <span class="badge bg-secondary px-3 py-1">
                          <i class="bi bi-x-circle"></i> Sin stock
                        </span>
                      {{/if}}
                    </div>
                  </div>
                </div>
                
                <!-- Acciones del producto -->
                <div class="col-md-4">
                  <div class="product-actions">
                    <div class="d-flex flex-column gap-2">
                      <!-- Bot√≥n principal de agregar al carrito -->
                      {{#if this.status}}
                        {{#if (gt this.stock 0)}}
                          <button class="btn btn-success btn-lg w-100" onclick="addToCart('{{this._id}}', this)">
                            <i class="bi bi-cart-plus"></i> Agregar al Carrito
                          </button>
                        {{else}}
                          <button class="btn btn-outline-secondary btn-lg w-100" disabled>
                            <i class="bi bi-x-circle"></i> Sin Stock
                          </button>
                        {{/if}}
                      {{else}}
                        <button class="btn btn-outline-danger btn-lg w-100" disabled>
                          <i class="bi bi-pause-circle"></i> No Disponible
                        </button>
                      {{/if}}
                      
                      <!-- Botones secundarios -->
                      <div class="d-flex gap-1">
                        <a href="/products/{{this._id}}" class="btn btn-outline-primary flex-fill">
                          <i class="bi bi-eye"></i> Ver Detalles
                        </a>
                        <button class="btn btn-outline-info" onclick="addToWishlist('{{this._id}}')" title="Agregar a favoritos">
                          <i class="bi bi-heart"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="shareProduct('{{this._id}}')" title="Compartir">
                          <i class="bi bi-share"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {{/each}}
          </div>
        </div>
        
        <!-- Footer con informaci√≥n del cat√°logo -->
        <div class="card-footer bg-light">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="stat-card">
                <i class="bi bi-box-seam text-primary fs-4"></i>
                <h6 class="mt-1 mb-0">{{products.length}}</h6>
                <small class="text-muted">Productos</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="bi bi-check-circle text-success fs-4"></i>
                <h6 class="mt-1 mb-0">‚úì</h6>
                <small class="text-muted">Disponibles</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="bi bi-tags text-info fs-4"></i>
                <h6 class="mt-1 mb-0">üì¶</h6>
                <small class="text-muted">Categor√≠as</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card">
                <i class="bi bi-currency-dollar text-warning fs-4"></i>
                <h6 class="mt-1 mb-0">üí∞</h6>
                <small class="text-muted">Precio Promedio</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paginaci√≥n mejorada -->
  {{#if pagination}}
  <div class="row mt-4">
    <div class="col-12">
      <nav aria-label="Paginaci√≥n de productos">
        <div class="d-flex justify-content-between align-items-center">
          <div class="pagination-info">
            <small class="text-muted">
              Mostrando {{pagination.currentPage}} de {{pagination.totalPages}} p√°ginas
              ({{pagination.totalDocs}} productos en total)
            </small>
          </div>
          <ul class="pagination mb-0">
            {{#if pagination.hasPrevPage}}
              <li class="page-item">
                <a class="page-link" href="?page={{pagination.prevPage}}&limit={{query.limit}}&sort={{query.sort}}&category={{query.category}}&status={{query.status}}">
                  <i class="bi bi-chevron-left"></i> Anterior
                </a>
              </li>
            {{else}}
              <li class="page-item disabled">
                <span class="page-link">
                  <i class="bi bi-chevron-left"></i> Anterior
                </span>
              </li>
            {{/if}}

            {{#each (range 1 pagination.totalPages)}}
              <li class="page-item {{#if (eq this ../pagination.currentPage)}}active{{/if}}">
                <a class="page-link" href="?page={{this}}&limit={{../query.limit}}&sort={{../query.sort}}&category={{../query.category}}&status={{../query.status}}">{{this}}</a>
              </li>
            {{/each}}

            {{#if pagination.hasNextPage}}
              <li class="page-item">
                <a class="page-link" href="?page={{pagination.nextPage}}&limit={{query.limit}}&sort={{query.sort}}&category={{query.category}}&status={{query.status}}">
                  Siguiente <i class="bi bi-chevron-right"></i>
                </a>
              </li>
            {{else}}
              <li class="page-item disabled">
                <span class="page-link">
                  Siguiente <i class="bi bi-chevron-right"></i>
                </span>
              </li>
            {{/if}}
          </ul>
        </div>
      </nav>
    </div>
  </div>
  {{/if}}
</div>

<script>
// Variable global para almacenar el carrito actual
let currentCartId = localStorage.getItem('currentCartId');

// Funci√≥n para obtener o crear carrito √∫nico
async function getOrCreateCart() {
  if (!currentCartId) {
    try {
      const response = await fetch('/api/carts', { method: 'POST' });
      if (response.ok) {
        const cart = await response.json();
        currentCartId = cart._id;
        localStorage.setItem('currentCartId', currentCartId);
      }
    } catch (error) {
      console.error('Error creando carrito:', error);
    }
  }
  return currentCartId;
}

// Funci√≥n para agregar producto al carrito
async function addToCart(productId, buttonElement) {
  try {
    // Asegurar que tenemos un carrito
    const cartId = await getOrCreateCart();
    if (!cartId) {
      showNotification('Error al crear carrito', 'danger');
      return;
    }
    
    // Agregar producto al carrito
    const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const result = await response.json();
      showNotification('¬°Producto agregado al carrito!', 'success');
      updateCartCounter();
      
      // Efecto visual en el bot√≥n si se proporciona
      if (buttonElement) {
        const originalText = buttonElement.innerHTML;
        buttonElement.innerHTML = '<i class="bi bi-check"></i> ¬°Agregado!';
        buttonElement.classList.add('btn-success');
        setTimeout(() => {
          buttonElement.innerHTML = originalText;
          buttonElement.classList.remove('btn-success');
        }, 2000);
      }
    } else {
      showNotification('Error al agregar producto al carrito', 'danger');
    }
  } catch (error) {
    console.error('Error:', error);
    showNotification('Error de conexi√≥n', 'danger');
  }
}

// Funci√≥n para agregar a lista de deseos
function addToWishlist(productId) {
  showNotification('Producto agregado a favoritos', 'info');
  // Aqu√≠ puedes implementar la l√≥gica de wishlist
}

// Funci√≥n para compartir producto
function shareProduct(productId) {
  if (navigator.share) {
    navigator.share({
      title: 'Producto incre√≠ble',
      text: 'Mira este producto en nuestra tienda',
      url: window.location.href + '/' + productId
    });
  } else {
    // Fallback: copiar al portapapeles
    navigator.clipboard.writeText(window.location.href + '/' + productId);
    showNotification('Link copiado al portapapeles', 'info');
  }
}

// Mostrar notificaciones tipo toast
function showNotification(message, type) {
  // Crear elemento de notificaci√≥n
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = `
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: none;
    border-radius: 10px;
  `;
  
  const icons = {
    success: '‚úÖ',
    danger: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <span class="me-2" style="font-size: 1.2rem;">${icons[type]}</span>
      <strong>${message}</strong>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-dismiss despu√©s de 3 segundos
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 3000);
}

// Actualizar contador del carrito en la navegaci√≥n
async function updateCartCounter() {
  if (!currentCartId) return;
  
  try {
    const response = await fetch(`/api/carts/${currentCartId}`);
    if (response.ok) {
      const cart = await response.json();
      const products = cart.products || [];
      const totalItems = Array.isArray(products) ? 
        products.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
      
      // Actualizar contador en el header
      const cartCounter = document.getElementById('cart-counter');
      if (cartCounter) {
        cartCounter.textContent = totalItems;
        cartCounter.style.display = totalItems > 0 ? 'inline' : 'none';
      }
      
      // Buscar y actualizar el contador en el navbar
      const cartLink = document.querySelector('a[href*="carrito"], a[href*="cart"]');
      if (cartLink) {
        let badge = cartLink.querySelector('.badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'badge bg-danger rounded-pill ms-1';
          cartLink.appendChild(badge);
        }
        badge.textContent = totalItems > 0 ? totalItems : '';
        badge.style.display = totalItems > 0 ? 'inline' : 'none';
      }
    }
  } catch (error) {
    console.error('Error actualizando contador:', error);
  }
}

// Funci√≥n para ir al carrito actual
function goToCurrentCart() {
  if (currentCartId) {
    window.location.href = `/carts/${currentCartId}`;
  } else {
    showNotification('No tienes un carrito activo. Agrega productos para crear uno.', 'info');
  }
}

// Inicializar cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  updateCartCounter();
  
  // Agregar enlace din√°mico al carrito en el navbar si existe
  const navCartLink = document.querySelector('a[href*="carrito"], a[href*="cart"]');
  if (navCartLink && currentCartId) {
    navCartLink.href = `/carts/${currentCartId}`;
  }
  
  // Efectos de hover en productos
  const productItems = document.querySelectorAll('.product-item');
  productItems.forEach(item => {
    item.addEventListener('mouseenter', function() {
      this.style.transform = 'translateX(5px)';
      this.style.backgroundColor = '#f8f9fa';
    });
    
    item.addEventListener('mouseleave', function() {
      this.style.transform = 'translateX(0)';
      this.style.backgroundColor = '';
    });
  });

  // Auto-submit del formulario cuando cambien los filtros
  const filterForm = document.querySelector('form');
  const filterSelects = document.querySelectorAll('select[name="category"], select[name="status"], select[name="sort"], select[name="limit"]');
  
  filterSelects.forEach(select => {
    select.addEventListener('change', function() {
      filterForm.submit();
    });
  });
});
</script>

<!-- Estilos CSS personalizados -->
<style>
.product-item {
  transition: all 0.3s ease;
  border-radius: 8px;
}

.product-item:hover {
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.product-image-wrapper {
  transition: transform 0.2s ease;
}

.product-image-wrapper:hover {
  transform: scale(1.05);
}

.price-section {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.current-price {
  position: relative;
}

.product-actions button {
  transition: all 0.2s ease;
}

.product-actions button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.bg-gradient-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.stat-card {
  transition: transform 0.2s ease;
  padding: 0.5rem;
}

.stat-card:hover {
  transform: translateY(-3px);
}

.pagination .page-link {
  border-radius: 8px;
  margin: 0 2px;
  border: 1px solid #dee2e6;
}

.pagination .page-item.active .page-link {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
}

.form-control:focus, .form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
}

@media (max-width: 768px) {
  .product-actions {
    margin-top: 1rem;
  }
  
  .price-section {
    margin-top: 1rem;
    text-align: left !important;
  }
  
  .stat-card {
    margin-bottom: 1rem;
  }
}

/* Animaciones para los botones */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.btn:active {
  animation: pulse 0.3s ease;
}

/* Efecto de carga en filtros */
.card-body form {
  transition: opacity 0.3s ease;
}

.card-body form:invalid {
  opacity: 0.7;
}
</style>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
